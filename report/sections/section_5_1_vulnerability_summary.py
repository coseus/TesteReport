# report/sections/section_5_1_vulnerability_summary.py

from reportlab.platypus import Paragraph, Spacer, Table, TableStyle
from reportlab.lib import colors
from reportlab.lib.units import mm

SEV_COLORS_HEX = {
    "Critical": "#e74c3c",
    "High": "#e67e22",
    "Moderate": "#f1c40f",
    "Low": "#3498db",
    "Informational": "#95a5a6",
}

SEV_ORDER = ["Critical", "High", "Moderate", "Low", "Informational"]

def build_section(elements, styles, report):
    elements.append(Paragraph("4.0 Vulnerability Summary", styles["HeadingModern"]))
    elements.append(Spacer(1, 6))

    counts = report.get("vuln_summary_counts", {})
    total = sum(counts.values())

    table_data = [
        [
            Paragraph("<b>Severity</b>", styles["TableCell"]),
            Paragraph("<b>Count</b>", styles["TableCell"]),
        ]
    ]

    for sev in SEV_ORDER:
        sev_color = SEV_COLORS_HEX[sev]
        label = f'<font color="{sev_color}"><b>{sev}</b></font>'
        table_data.append([
            Paragraph(label, styles["TableCell"]),
            Paragraph(str(counts.get(sev, 0)), styles["TableCell"]),
        ])

    tbl = Table(table_data, colWidths=[60*mm, 25*mm])
    tbl.setStyle(TableStyle([
        ("BACKGROUND", (0,0), (-1,0), colors.lightgrey),
        ("GRID", (0,0), (-1,-1), 0.25, colors.grey),
        ("VALIGN", (0,0), (-1,-1), "MIDDLE"),
        ("ALIGN", (1,1), (1,-1), "CENTER"),
    ]))

    elements.append(tbl)
    elements.append(Spacer(1, 12))

    elements.append(Paragraph(f"Total Vulnerabilities: <b>{total}</b>", styles["NormalHelv"]))
    elements.append(Spacer(1, 14))

    # OPTIONAL: Host-level vulnerability summary (table)
    hostmap = report.get("vuln_by_host", {})
    if hostmap:
        elements.append(Paragraph("Host-Based Vulnerability Distribution", styles["SubHeading"]))
        elements.append(Spacer(1, 6))

        # header
        host_table = [
            [Paragraph("<b>Host</b>", styles["TableCell"])]
            + [Paragraph(f'<b>{sev}</b>', styles["TableCell"]) for sev in SEV_ORDER]
        ]

        for host, sevmap in hostmap.items():
            row = [Paragraph(host, styles["TableCell"])]
            for sev in SEV_ORDER:
                row.append(Paragraph(str(sevmap.get(sev, 0)), styles["TableCell"]))
            host_table.append(row)

        host_tbl = Table(host_table, colWidths=[40*mm] + [18*mm]*5)
        host_tbl.setStyle(TableStyle([
            ("BACKGROUND", (0,0), (-1,0), colors.lightgrey),
            ("GRID", (0,0), (-1,-1), 0.25, colors.grey),
            ("VALIGN", (0,0), (-1,-1), "MIDDLE"),
            ("ALIGN", (1,1), (-1,-1), "CENTER"),
        ]))

        elements.append(host_tbl)
        elements.append(Spacer(1, 14))
